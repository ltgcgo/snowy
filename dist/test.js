"use strict";(function(){var m=function(s,a,t){var i;var n;if(self.MessageEvent)switch(s){case"message":{n=new MessageEvent(s,{data:a,ports:t==null?void 0:t.ports}),Object.defineProperty(n,"source",{value:t==null?void 0:t.source});break}default:n=new Event(s)}else n=document.createEvent("Event"),n.initEvent(s,!1,!1),t&&s=="message"&&(n.data=a,t.source&&Object.defineProperty(n,"source",{value:t.source}),(i=t.ports)!=null&&i.length&&Object.defineProperty(n,"ports",{value:t.ports}));return n};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),h=[],c={},b=function(s){var M;var a=this;if((this==null?void 0:this.constructor)!=b)throw new TypeError("Illegal constructor");h.push(this),(M=c[s])!=null&&M.constructor||(c[s]=[]),c[s].push(this);var t=Math.floor(Math.random()*281474976710656),n=[],i=0,u=[],g=!0,w=!1;Object.defineProperty(this,"id",{get:function(){return t}}),Object.defineProperty(this,"name",{value:s}),this.close=function(){var o;var e=h.indexOf(a);e>-1?(f.postMessage({t:"d",c:s,i:t}),h.splice(e,1),(o=c[s])!=null&&o.constructor&&(e=c[s].indexOf(a),e>-1&&c[s].splice(e,1)),c[s].length||delete c[s],console.debug("[Snowy] BroadcastChannel closed."),w=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(e){if(f){if(w)throw new Error("Channel already closed");f.postMessage({t:"m",c:s,i:t,m:i,d:e}),i++,i>4294967295&&(i=0)}else u.push(e),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(f){if(g){for(f.postMessage({t:"r",c:s,i:t}),console.debug("[Snowy] ".concat(u.length," message(s) in cache."));u.length;){var e=u.shift();a.postMessage(e)}g=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(e){e.c==s?e.i!=t&&a.dispatchEvent(m("message",e.d,{source:a})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(t," receives from ").concat(s,", not ").concat(e.c,"."))};var r={};this.dispatchEvent=function(e){var v,y;if(Object.defineProperty(e,"target",{value:a}),Object.defineProperty(e,"currentTarget",{value:a}),(v=r[e.type])!=null&&v.length)for(var o=r[e.type],l=0;l<o.length;l++)((y=o[l])==null?void 0:y.constructor)==Function&&o[l].call(a,e);a["on".concat(e.type)]&&a["on".concat(e.type)].constructor==Function&&a["on".concat(e.type)].call(a,e)},this.addEventListener=function(e,o){var v;(v=r[e])!=null&&v.constructor||(r[e]=[]);var l=r[e].indexOf(o);l==-1&&r[e].push(o)},this.removeEventListener=function(e,o){var v,y;if((v=r[e])!=null&&v.length){var l=r[e].indexOf(o);l>-1&&r[e].splice(l,1)}!((y=r[e])!=null&&y.length)&&r[e].constructor&&delete r[e]}},self.BroadcastChannel=b,d=function(){if(f){f.addEventListener("message",function(a){var t=a.data,n=!1;switch(t.t){case"k":{n=!1,f.postMessage({t:"k"});break}case"m":{var i=c[t.c];if(i!=null&&i.length)for(var u=0;u<i.length;u++)i[u].receiveMessage(t);break}case"c":{for(var g=[],w=0;w<h.length;w++){var r=h[w].name;g.indexOf(r)<0&&g.push(r)}f.postMessage({t:"k",c:g});break}default:n=!0}n&&console.info("ReceiveBroadcast",t)});for(var s=0;s<h.length;s++)h[s].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},O=function(){if(!f){var s=new SharedWorker(self.SNOWY_PATH||"/snowy.js");s.port.start();var a=function(t){t.data.t=="swc"&&(s.port.removeEventListener("message",a),f=s.port,f.postMessage({t:"k"}),d())};s.port.addEventListener("message",a)}},O());var f,h,c,b,d,O;self.testChannel=new BroadcastChannel("cc.ltgc.snowy:PublicChannel");testChannel.addEventListener("message",function(s){console.info(s)});for(E=1;E<=8;E++)testChannel.postMessage("Test message #".concat(E,"!"));var E;})();
